<!DOCTYPE html>

<html>
<head>
  <title>arguable.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="arguable.js.html">
                  arguable.js
                </a>


                <a class="source" href="bindable.js.html">
                  bindable.js
                </a>


                <a class="source" href="code.js.html">
                  code.js
                </a>


                <a class="source" href="exit.js.html">
                  exit.js
                </a>


                <a class="source" href="getopt.js.html">
                  getopt.js
                </a>


                <a class="source" href="numeric.js.html">
                  numeric.js
                </a>


                <a class="source" href="program.js.html">
                  program.js
                </a>


                <a class="source" href="usage.js.html">
                  usage.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>arguable.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> exit = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./exit'</span>)

<span class="hljs-keyword">var</span> Program = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./program'</span>)

<span class="hljs-keyword">var</span> slice = [].slice

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Use given stream or create pseudo-stream.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStream</span> (<span class="hljs-params">s</span>) </span>{ <span class="hljs-keyword">return</span> s || <span class="hljs-keyword">new</span> stream.PassThrough }

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Variadic arguments.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> vargs = slice.call(<span class="hljs-built_in">arguments</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>First argument is always the module.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = vargs.shift()

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Usage source can be specified explicitly, or else it is sought in the
comments of the main module.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> usage = <span class="hljs-keyword">typeof</span> vargs[<span class="hljs-number">0</span>] == <span class="hljs-string">'string'</span>
              ? vargs.shift()
              : <span class="hljs-built_in">module</span>.filename

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Check for default values for named parameters when argument parser is
invoked as a main module.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> defaults = <span class="hljs-keyword">typeof</span> vargs[<span class="hljs-number">0</span>] == <span class="hljs-string">'object'</span> ? vargs.shift() : {}

</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Ensure we have defaults.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    defaults.argv || (defaults.argv = [])
    defaults.properties || (defaults.properties = [])

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Main body of argument parser or program is final argument.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> main = vargs.shift()

    <span class="hljs-keyword">var</span> properties = vargs.shift() || {}

    <span class="hljs-keyword">var</span> invoke = <span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">argv, options, callback</span>) </span>{
        <span class="hljs-keyword">var</span> vargs = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-built_in">arguments</span>.length &gt;= <span class="hljs-number">3</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>)
        <span class="hljs-keyword">var</span> parameters = []
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(argv)) {
            argv = [ argv ]
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> object = {}
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> argv) {
                object[key] = argv[key]
            }
            argv = [ object ]
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(object.argv)) {
                argv.push(object.argv)
                <span class="hljs-keyword">delete</span> object.argv
            }
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options == <span class="hljs-string">'function'</span>) {
            callback = options
            options = {}
        }
        argv.unshift(defaults.argv)
        argv = argv.slice()
        <span class="hljs-keyword">while</span> (argv.length != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> argument = argv.shift()
            <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">typeof</span> argument) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>:
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(argument)) {
                    argv.unshift.apply(argv, argument)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> ((<span class="hljs-string">'name'</span> <span class="hljs-keyword">in</span> argument) &amp;&amp;
                        (<span class="hljs-string">'value'</span> <span class="hljs-keyword">in</span> argument) &amp;&amp;
                        <span class="hljs-built_in">Object</span>.keys(argument).length == <span class="hljs-number">2</span>
                    ) {
                        parameters.push(argument)
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> name <span class="hljs-keyword">in</span> argument) {
                            parameters.push({ <span class="hljs-attr">name</span>: name, <span class="hljs-attr">value</span>: argument[name] })
                        }
                    }
                }
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">default</span>:
                parameters.push(argument)
                <span class="hljs-keyword">break</span>
            }
        }
</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>What weâ€™re shooting for here is this:</p>
<p>  Create a signature that would be a reasonable signature for a
  generic function that is not an Arguable argument parser.</p>
<p>  Or put another way, tell the user to create an argument parser that
  accepts an arguments array and a pseudo-process, the program, and a
  callback, so that you can tell them to either use Arguable, or else
  implement an argument parser that accepts reasonable arguments as
  opposed to accepting convoluted named parameters.</p>
<p>If options is really an <code>EventEmitter</code>, then our argument parser is
being called as a universal submodule. This is an interface that
allows a library module author to document that a submodule accepts
an arguments array and a signal handler. The library module author
can document as many <code>Program</code> features as they would like, or they
could simply say that it is only for events, or they can say that it
is mean to be ignored by the submodule author.</p>
<p>Now the submodule author can use Arguable for their argument parser
and program will be correctly configured, or they can create a
function that takes the argument array and use the argument parser
module of their choice. Additional properties are arguments to the
argument parser, not properties on this mystery event emitter.</p>

            </div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Note that all the other options are debugging options.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (options <span class="hljs-keyword">instanceof</span> events.EventEmitter) {
            options = { <span class="hljs-attr">events</span>: options }
            options.stdin = options.events.stdin
            options.stdout = options.events.stdout
            options.stderr = options.events.stderr
        }
</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO Okay, now we have space for additional arguments that follow the
event emitter or the options. These can be passed in as variadic
arguments to be interpreted by the caller. This can be experimental.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> send = options.send || options.events &amp;&amp; options.events.send &amp;&amp; <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            options.events.send.apply(options.events, slice.call(<span class="hljs-built_in">arguments</span>))
        }
        <span class="hljs-keyword">var</span> ee = options.events
        <span class="hljs-keyword">if</span> (ee == <span class="hljs-literal">null</span>) {
            ee = <span class="hljs-keyword">new</span> events.EventEmitter
            ee.mainModule = process.mainModule
            ee.connected = (<span class="hljs-string">'connected'</span> <span class="hljs-keyword">in</span> options) ? options.connected : <span class="hljs-literal">true</span>
            ee.disconnect = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">this</span>.connected = <span class="hljs-literal">false</span> }
        }
        <span class="hljs-keyword">var</span> isMainModule = (<span class="hljs-string">'isMainModule'</span> <span class="hljs-keyword">in</span> options)
                         ? options.isMainModule
                         : process.mainModule === <span class="hljs-built_in">module</span>
        <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">new</span> Program(usage, parameters, {
            <span class="hljs-attr">module</span>: <span class="hljs-built_in">module</span>,
            <span class="hljs-attr">stdout</span>: createStream(options.stdout),
            <span class="hljs-attr">stdin</span>: createStream(options.stdin),
            <span class="hljs-attr">stderr</span>: createStream(options.stderr),
            <span class="hljs-attr">isMainModule</span>: isMainModule,
            <span class="hljs-attr">events</span>: ee,
            <span class="hljs-attr">properties</span>: [ defaults.properties, properties, options.properties || {} ],
            <span class="hljs-attr">send</span>: send || <span class="hljs-literal">null</span>,
            <span class="hljs-attr">env</span>: options.env || {}
        })
</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO This delay is to allow users to do something with the pass
through streams and event emitter.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        process.nextTick(main.bind.apply(main, [ <span class="hljs-literal">null</span>, program ].concat(vargs)))
        <span class="hljs-keyword">return</span> program
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">module</span> === process.mainModule) {
        invoke(process.argv.slice(<span class="hljs-number">2</span>), {
</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>No. Stop! There is no <code>process.stdio</code>. Do not add one! (Again.)</p>

            </div>

            <div class="content"><div class='highlight'><pre>            env: process.env,
            <span class="hljs-attr">stdout</span>: process.stdout,
            <span class="hljs-attr">stdin</span>: process.stdin,
            <span class="hljs-attr">stderr</span>: process.stderr,
            <span class="hljs-attr">events</span>: process
        }, exit(process))
    }
}

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
